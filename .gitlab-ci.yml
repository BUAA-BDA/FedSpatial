image: "docker/compose:1.28.5"

services:
  - docker:dind

before_script:
  - docker info
  - docker-compose --version

stages:
  - build
  - test

build:
  stage: build
  script:
    - cd docker/build
    - docker-compose up
  artifacts:
    paths:
      - release/
    expire_in: 20 minutes

test:
  stage: test
  before_script:
    - cd docker/user
    - docker-compose down
    - cd ../owner
    - docker-compose down
    - cd ../database
    - docker-compose down
    - cd ../..
  script:
    - cd docker/database
    - docker-compose up -d
    - sleep 5
    - cd ../owner
    - cp -r ../cert/ci cert
    - docker-compose up -d
    - cd ../test
    - docker-compose up
  after_script:
    - cd docker/test
    - docker-compose down
    - cd ../owner
    - docker-compose down
    - cd ../database
    - docker-compose down
  artifacts:
    when: always
    reports:
      junit:
        - rpc/target/surefire-reports/TEST-*.xml
        - mpc/target/surefire-reports/TEST-*.xml
        - data/target/surefire-reports/TEST-*.xml
        - plan/target/surefire-reports/TEST-*.xml
        - user/target/surefire-reports/TEST-*.xml
    expire_in: 20 minutes